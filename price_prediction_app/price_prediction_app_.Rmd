---
title: "Price Prediction App"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll #was: "fill"
    css: "css/styles-default.css"
    logo: "img/logo-cannondale.png"
runtime: shiny
resource_files:
- bike_img/bad_habit.jpg
- bike_img/beast_of_the_east.png
- bike_img/caad8.jpg
- bike_img/caad12.jpg
- bike_img/catalyst.jpg
- bike_img/f_si.png
- bike_img/fat_caad.jpg
- bike_img/habit.jpg
- bike_img/jekyll.jpg
- bike_img/scalpel.png
- bike_img/slice.jpg
- bike_img/supersix.jpg
- bike_img/superx.jpg
- bike_img/synapse.jpg
- bike_img/trail.jpg
- bike_img/trigger.jpg
---

```{r setup, include=FALSE}

# 1.0 Libraries ----

# App
library(flexdashboard)
library(shiny)
library(shinyjs)
library(shinyWidgets)
library(rsconnect)

# Core
library(tidyverse)
library(tidyquant)
# fs is used to work with the file system
library(fs)

# Visualizations
library(plotly)

# Modeling
library(parsnip)
library(xgboost)

# Database
library(odbc)
library(RSQLite)



# 2.0 Data ----
con <- dbConnect(RSQLite::SQLite(), "data/bikes_database.db")
# con <- dbConnect(RSQLite::SQLite(), "00_data/bikes_database.db")
# dbListTables(con)
bikes_tbl <- tbl(con, "bikes") %>% collect()
dbDisconnect(con)

# Scripts
source("scripts/02_process_data.R")
source("scripts/03_make_predictions.R")
source("scripts/plot_bike_prediction_cannondale.R")

# Model
model_xgboost <- read_rds("models/model_xgboost.rds")
```

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
useShinyjs(rmd = TRUE)

# Bike Model Components ----
choices_base_model <- bikes_tbl %>%
  separate_bike_model(keep_model_column = FALSE, append = FALSE) %>%
  distinct(model_base) %>%
  arrange(model_base)

choices_tier <- c("Ultegra", "Red", "Dura_Ace", "Team", "Black")
  
choices_features <- c("Hi_Mod", "Disc")

h4("Bike Configuration")
# 1. Base Name (e.g. Jekyll)
pickerInput(inputId = "input_base_model", 
            label   = "Base Model", 
            choices = choices_base_model$model_base, 
            selected = "Jekyll",
            options = list(container = "body"))

# 2. Tier (e.g. Al 1)
pickerInput(inputId = "input_tier", 
            label   = "Tier / Material", 
            choices = choices_tier, 
            selected = "Black",
            options = list(container = "body"))

# 3. Features (e.g. Black Inc.)
# using awesomeCheckboxGroup for a nicer look, or standard checkboxGroupInput
awesomeCheckboxGroup(
  inputId = "input_features",
  label   = "Features (Check all that apply)",
  choices = choices_features,
  selected = NULL,
  inline  = TRUE # Makes them sit side-by-side to save vertical space
)


# Bike Family (Category 2) ----

category_hierachy_tbl <- bikes_tbl %>% 
  separate_bike_description(keep_description_column = TRUE, append = FALSE) %>%
  distinct(category_1, category_2)

pickerInput(inputId  = "picker_category_2", 
            label    = h4("Bike Family"), 
            choices  = category_hierachy_tbl$category_2,
            options = list(container = "body"),
            selected = "Over Mountain")
  

# Bike Type (Category 1) ----

bike_type <- reactive({
  category_hierachy_tbl %>%
    filter(category_2 == input$picker_category_2) %>%
    pull(category_1)
})

output$bike_type <- renderText(bike_type())

h4("Bike Type")
textOutput(outputId = "bike_type", inline= TRUE) %>% em() %>% strong()

# Frame Material ----
br()
pickerInput(inputId  = "picker_frame_material", 
            label    = h4("Frame Material"), 
            choices  = c("Aluminum", "Carbon"),
            options = list(container= "body"),
            selected = "Aluminum")


br()
hr()
br()

actionButton(inputId = "apply", label = "Apply", icon = icon(name = "play", lib = "font-awesome"))

actionButton("reset", label = "Reset", icon = icon("sync"))

br()
br()
br()

observeEvent(eventExpr = input$reset, handlerExpr = {
  # Reset Base Model
  updatePickerInput(session = session, inputId = "input_base_model", selected = "Jekyll")
  
  # Reset Tier
  updatePickerInput(session = session, inputId = "input_tier", selected = "Black")
  
  # Reset Features
  updateAwesomeCheckboxGroup(session = session, inputId = "input_features", selected = character(0))
  
  updatePickerInput(session = session, inputId = "picker_category_2", selected = "Over Mountain")
  
  updatePickerInput(session = session, inputId = "picker_frame_material", selected = "Aluminum")
  
  delay(ms = 300, expr = {
    click(id = "apply")
  })
  
})

```


Column {data-width=650}
-----------------------------------------------------------------------

```{r}
# CONSTRUCT BIKE TEXT STRING ----
# This creates a reactive string: "Jekyll" + "Black" + "No features"
bike_model_text_constructed <- reactive({
  
  # Paste components together with spaces
  text <- paste(input$input_base_model, 
                input$input_tier, 
                paste(input$input_features, collapse = " "))
  
  # Clean up extra spaces (if no features are selected)
  text <- str_squish(text)
  
  return(text)
})


new_bike_tbl <- eventReactive(eventExpr = input$apply, valueExpr = {
  
  generate_new_bike(
    bike_model = bike_model_text_constructed(), 
    category_1 = bike_type(), 
    category_2 = input$picker_category_2, 
    frame_material = input$picker_frame_material, 
    .ml_model = model_xgboost)
  
}, ignoreNULL = FALSE)


```


### Price Prediction vs Product Portfolio

```{r}
# renderPrint(new_bike_tbl())

output$plotly_1 <- renderPlotly({
  bind_bike_prediction(bikes_tbl, new_bike_tbl()) %>%
    plot_bike_prediction_cannondale %>%
    config(displayModeBar = FALSE)
})

plotlyOutput("plotly_1")

```

Column {data-width=350}
-----------------------------------------------------------------------

### Price Prediction Used These Features

```{r}
renderTable({
  new_bike_tbl() %>% format_table()
})


```


### Images

```{r}
renderImage({
  
  # 1. Prepare the filename string (Existing logic)
  detect <- new_bike_tbl() %>%
    pull(model_base) %>%
    str_to_lower() %>%
    str_replace_all("-", "_") %>%
    str_replace_all(" ", "_")
  
  detect <- ifelse(detect %in% c("caad12", "caad8"),
                   yes = detect,
                   no = detect %>% str_remove_all(pattern = "[[:digit:]]"))
  
  # 2. Find the file (Safely)
  directory_files <- fs::dir_ls("bike_img")
  
  # We look for the pattern
  detection_results <- directory_files %>%
    str_detect(pattern = str_glue("bike_img/{detect}"))
  
  path <- directory_files[detection_results]
  
  # 3. Robust Error Handling (New Feature)
  # If no image is found, use the logo as a fallback so the app doesn't crash
  if (length(path) == 0) {
    path <- "img/logo-cannondale.png" 
    alt_text <- "Image not available"
  } else {
    # If multiple images match, take the first one to avoid list errors
    path <- path[1] 
    alt_text <- detect
  }
  
  # 4. Render with Mobile Constraints
  list(
    src = path,
    contentType = "image/png",
    alt = alt_text,
    # This style string is critical for mobile responsiveness:
    # - max-height: Prevents image from pushing content off the bottom of a phone
    # - object-fit: Ensures the bike isn't squashed or stretched
    # - margin: 0 auto: Centers the image
    style = "display: block; margin: 0 auto; max-width: 100%; max-height: 300px; height: auto; object-fit: contain;"
  )
  
}, deleteFile = FALSE)
```
